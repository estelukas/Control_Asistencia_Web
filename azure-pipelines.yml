trigger:
- ControlAsistencia  # ğŸ”¹ Habilita CI en la rama principal

pool:
  name: Default

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:
# ğŸ”¹ 1ï¸âƒ£ Instalar herramientas necesarias
- task: NuGetToolInstaller@1

# ğŸ”¹ 2ï¸âƒ£ Restaurar paquetes NuGet
- task: NuGetCommand@2
  inputs:
    restoreSolution: '$(solution)'

# ğŸ”¹ 3ï¸âƒ£ Preparar anÃ¡lisis de SonarQube
- task: SonarQubePrepare@7
  inputs:
    SonarQube: 'SonarQube'
    scannerMode: 'dotnet'
    projectKey: 'ControlAsistencia_XCF_App'
    projectName: 'ControlAsistencia_XCF_App'
    extraProperties: |
      sonar.host.url=http://localhost:9000
      sonar.cs.vscoveragexml.reportsPaths=$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml

# ğŸ”¹ 4ï¸âƒ£ Compilar la soluciÃ³n
- task: VSBuild@1
  inputs:
    solution: '$(solution)'
    msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(build.artifactStagingDirectory)\WebApp.zip" /p:DeployIisAppPath="Default Web Site"'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'

# ğŸ”¹ 5ï¸âƒ£ Ejecutar pruebas con cobertura (Usando Coverlet para generar cobertura en formato Cobertura)
- task: DotNetCoreCLI@2
  displayName: 'ğŸ§ª Ejecutar pruebas con cobertura'
  inputs:
    command: 'test'
    projects: '**/*Tests/*.csproj'
    arguments: '--configuration $(buildConfiguration) /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:CoverletOutput=$(Agent.TempDirectory)/TestResults/coverage.cobertura.xml'

# ğŸ”¹ 6ï¸âƒ£ Verificar si coverage.cobertura.xml se generÃ³ correctamente
- powershell: |
    Write-Host "ğŸ” Verificando archivos en $(Agent.TempDirectory)/TestResults:"
    Get-ChildItem -Path "$(Agent.TempDirectory)/TestResults" -Recurse | ForEach-Object { Write-Host $_.FullName }
  displayName: 'ğŸ” Verificar archivos de cobertura'

# ğŸ”¹ 7ï¸âƒ£ Publicar cobertura de cÃ³digo
- task: PublishCodeCoverageResults@1
  displayName: 'ğŸ“Š Publicar cobertura de cÃ³digo'
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(Agent.TempDirectory)/TestResults/coverage.cobertura.xml'
    reportDirectory: '$(Agent.TempDirectory)/TestResults'

# ğŸ”¹ 8ï¸âƒ£ Ejecutar anÃ¡lisis de cÃ³digo con SonarQube
- task: SonarQubeAnalyze@7

# ğŸ”¹ 9ï¸âƒ£ Publicar resultados del anÃ¡lisis en SonarQube
- task: SonarQubePublish@7
  inputs:
    pollingTimeoutSec: '300'